{% extends "user/base.html" %}
{% load static %}


{% block title %}На ковчеге - Платформа для поддержки российской культуры{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/fonts/addFonts.css' %}">
<link rel="stylesheet" href="{% static 'css/subscription/style.css' %}" />
<link rel="stylesheet" href="{% static 'css/subscription/buttons.css' %}" />
<link rel="stylesheet" href="{% static 'css/subscription/global-colors.css' %}" />
<link rel="stylesheet" href="{% static 'css/subscription/global-fonts.css' %}" />
<link rel="stylesheet" href="{% static 'css/subscription/style-reset.css' %}" />
<link rel="stylesheet" href="{% static 'css/profile/stylePersonalAccountSideBar.css' %}" />
{% endblock %}

{% block header %}
{% include "include/profileHeader.html" %}
{% endblock %}


{% block content %}
<div class="edit__fon"></div>
<div class="page-overlay"></div>
<div class="go-back">
    <img class="go-back__ornament" src="{% static 'images/subscription/new-tariff-page-subheader-ornament.svg' %}">
    <img class="go-back__ornament--mobile" src="{% static 'images/subscription/new-tariff-page-ornament--mobile.svg' %}">
</div>    
<main class="main">
    <div class="container">
        <button class="go-back__button" onclick="window.history.back()">
            <i class="fas fa-chevron-left"></i> Назад
        </button>
        <div class="title-wrapper">
            <h1>{% if form.instance.pk %}Редактировать подписку{% else %}Создать подписку{% endif %}</h1>
        </div>

        <form class="form" method="post" enctype="multipart/form-data" id="subscriptionForm" autocomplete="off">
            {% csrf_token %}
            
            <!-- Вывод общих ошибок формы -->
            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
            {% endif %}

            <div class="form__content">
                <div class="form__column-left">
                    <div class="upload-box">
                        <!-- Исправленный input для загрузки изображения -->
                        {{ form.image }}
                        <label for="{{ form.image.id_for_label }}" class="upload-btn" style="margin: 0 !important;">
                            <img src="{% static 'images/subscription/upload-img.svg' %}"><span>Загрузить иллюстрацию</span>
                        </label>
                        <div class="tariff__upload-hint">
                            Рекомендуемый размер: 250 × 100px<br/>Весом не более 5 мб
                        </div>
                        <!-- Контейнер для превью изображения -->
                        <div class="image-preview" id="imagePreview" style="display: none;">
                            <img id="previewImage" src="" alt="Превью изображения">
                            <span id="removeImage" class="remove-image">×</span>
                        </div>
                        {% if form.image.errors %}
                        <div class="error-message">
                            {% for error in form.image.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <fieldset class="tariff__title">
                        <label for="id_name">Название подписки</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                        <div class="error-message">
                            {% for error in form.name.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </fieldset>
                    
                    <fieldset class="tariff__description">
                        <label for="id_description">Что входит в подписку</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="error-message">
                            {% for error in form.description.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </fieldset>
                    
                    <fieldset class="tariff__price">
                        <label for="id_price">Стоимость за месяц</label>
                        <div class="tariff__price-content">
                            {{ form.price }}
                        </div>
                        <span class="tariff__price-hint">Не более 100 000₽</span>
                        {% if form.price.errors %}
                        <div class="error-message">
                            {% for error in form.price.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </fieldset>
                    
                    <div class="create-tariff create-tariff--desctop">
                        <button type="submit" class="button">
                            {% if form.instance.pk %}Обновить подписку{% else %}Сформировать подписку{% endif %}
                        </button>
                        {% if not form.instance.pk %}
                        {% comment %} <button type="button" class="button button--secondary" id="clearForm">
                            Очистить форму
                        </button> {% endcomment %}
                        {% endif %}
                    </div>
                </div>
                <div class="form__column-right">
                    <div class="toggle-item-box">
                        <label class="toggle-item">
                            Ограниченное количество подписчиков
                            <div class="switch">
                                {{ form.is_limited_subscribers }}
                                <span class="slider-bg"></span>
                            </div>
                        </label>
                        {{ form.max_subscribers }}
                        {% if form.max_subscribers.errors %}
                        <div class="error-message">
                            {% for error in form.max_subscribers.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                
                    <div class="toggle-item-box">
                        <label class="toggle-item">
                            Активировать скидку
                            <div class="switch">
                                {{ form.is_discount_active }}
                                <span class="slider-bg"></span>
                            </div>
                        </label>
                        <div class="slider-wrapper" id="discountSliderWrapper">
                            <input type="range" name="discount_percent" min="0" max="50" step="1" value="0" 
                                   class="slider" id="id_discount_percent" />
                            <div class="slider-fill" id="discountFill"></div>
                            <div class="slider-value" id="discountValue">0%</div>
                        </div>
                        {% if form.discount_percent.errors %}
                        <div class="error-message">
                            {% for error in form.discount_percent.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                
                    <div class="toggle-item-box">
                        <label class="toggle-item">
                            Добавить пробный период
                            <div class="switch">
                                {{ form.has_trial_period }}
                                <span class="slider-bg"></span>
                            </div>
                        </label>
                        <div class="slider-wrapper" id="trialSliderWrapper">
                            <input type="range" name="trial_days" min="14" max="28" step="1" value="14" 
                                   class="slider" id="id_trial_days" />
                            <div class="slider-fill" id="trialFill"></div>
                            <div class="slider-value" id="trialValue">14 дней</div>
                        </div>
                        {% if form.trial_days.errors %}
                        <div class="error-message">
                            {% for error in form.trial_days.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="create-tariff create-tariff--mobile">
                <button type="submit" class="button">
                    {% if form.instance.pk %}Обновить подписку{% else %}Сформировать подписку{% endif %}
                </button>
                {% if not form.instance.pk %}
                {% comment %} <button type="button" class="button button--secondary" id="clearFormMobile">
                    Очистить форму
                </button> {% endcomment %}
                {% endif %}
            </div>
        </form>
    </div>
</main>
{% endblock %}

{% block footer %}
{% include "include/baseFooter.html" %}
{% endblock %}

{% block extra_scripts %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{% static 'js/header/header.js' %}"></script>
    <script src="{% static 'js/subscription/navMenuMobile.js' %}"></script>
    <script src="{% static 'js/subscription/newTariffFormMaintenance.js' %}"></script>
    <script src="{% static 'js/profile/scriptPersonalAccountSideBar.js' %}"></script>

<script>
// JavaScript для принудительной очистки формы при создании
document.addEventListener('DOMContentLoaded', function() {
    // Функция для полной очистки формы
    function forceClearForm() {
        console.log('Очистка формы создания подписки...');
        
        // Очищаем текстовые поля
        const nameField = document.getElementById('id_name');
        const descField = document.getElementById('id_description');
        const priceField = document.getElementById('id_price');
        const maxSubsField = document.getElementById('id_max_subscribers');
        
        if (nameField) nameField.value = '';
        if (descField) descField.value = '';
        if (priceField) priceField.value = '';
        if (maxSubsField) maxSubsField.value = '1000';
        
        // Сбрасываем чекбоксы
        const limitedCheckbox = document.getElementById('id_is_limited_subscribers');
        const discountCheckbox = document.getElementById('id_is_discount_active');
        const trialCheckbox = document.getElementById('id_has_trial_period');
        
        if (limitedCheckbox) limitedCheckbox.checked = false;
        if (discountCheckbox) discountCheckbox.checked = false;
        if (trialCheckbox) trialCheckbox.checked = false;
        
        // Сбрасываем слайдеры к значениям по умолчанию
        const discountSlider = document.getElementById('id_discount_percent');
        const trialSlider = document.getElementById('id_trial_days');
        
        if (discountSlider) {
            discountSlider.value = '0';
            updateSliderDisplay(discountSlider, 'discountValue', 'discountFill', '%');
        }
        
        if (trialSlider) {
            trialSlider.value = '14';
            updateSliderDisplay(trialSlider, 'trialValue', 'trialFill', ' дней');
        }
        
        // Очищаем изображение
        const imageInput = document.getElementById('{{ form.image.id_for_label }}');
        const imagePreview = document.getElementById('imagePreview');
        const uploadBtn = document.querySelector('.upload-btn');
        
        if (imageInput && imagePreview && uploadBtn) {
            imageInput.value = '';
            imagePreview.style.display = 'none';
            uploadBtn.style.display = 'flex';
        }
        
        // Скрываем поле максимальных подписчиков
        if (maxSubsField) {
            maxSubsField.style.display = 'none';
        }
        
        console.log('Форма очищена');
    }
    
    // Функция для обновления отображения слайдеров
    function updateSliderDisplay(slider, valueId, fillId, suffix) {
        const valueElement = document.getElementById(valueId);
        const fillElement = document.getElementById(fillId);
        
        if (valueElement && fillElement) {
            valueElement.textContent = slider.value + suffix;
            const percent = (slider.value - slider.min) / (slider.max - slider.min) * 100;
            fillElement.style.width = percent + '%';
        }
    }
    
    // Очищаем форму только при создании (не при редактировании)
    {% if not form.instance.pk %}
    // Принудительно очищаем форму сразу после загрузки
    setTimeout(() => {
        forceClearForm();
    }, 50);
    {% endif %}
    
    // Обработчики для кнопок очистки
    document.getElementById('clearForm')?.addEventListener('click', forceClearForm);
    document.getElementById('clearFormMobile')?.addEventListener('click', forceClearForm);
    
    // Остальной JavaScript для работы формы
    const discountRange = document.getElementById('id_discount_percent');
    const discountValue = document.getElementById('discountValue');
    const discountFill = document.getElementById('discountFill');
    
    if (discountRange) {
        discountRange.addEventListener('input', function() {
            updateSliderDisplay(this, 'discountValue', 'discountFill', '%');
        });
    }
    
    const trialRange = document.getElementById('id_trial_days');
    const trialValue = document.getElementById('trialValue');
    const trialFill = document.getElementById('trialFill');
    
    if (trialRange) {
        trialRange.addEventListener('input', function() {
            updateSliderDisplay(this, 'trialValue', 'trialFill', ' дней');
        });
    }
    
    // Показ/скрытие поля максимальных подписчиков
    const limitedSubscribersToggle = document.getElementById('id_is_limited_subscribers');
    const maxSubscribersInput = document.getElementById('id_max_subscribers');
    
    if (limitedSubscribersToggle && maxSubscribersInput) {
        limitedSubscribersToggle.addEventListener('change', function() {
            maxSubscribersInput.style.display = this.checked ? 'block' : 'none';
        });
    }

    // Функционал для превью изображения
    const imageInput = document.getElementById('{{ form.image.id_for_label }}');
    const imagePreview = document.getElementById('imagePreview');
    const previewImage = document.getElementById('previewImage');
    const removeImageBtn = document.getElementById('removeImage');
    const uploadBtn = document.querySelector('.upload-btn');

    if (imageInput) {
        imageInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.addEventListener('load', function() {
                    previewImage.src = reader.result;
                    imagePreview.style.display = 'block';
                    uploadBtn.style.display = 'none';
                });
                reader.readAsDataURL(file);
            }
        });

        removeImageBtn.addEventListener('click', function(e) {
            e.preventDefault();
            imageInput.value = '';
            imagePreview.style.display = 'none';
            uploadBtn.style.display = 'flex';
        });
    }
});
</script> 

{% endblock %}