{% extends "user/base.html" %}
{% load static %}

{% block title %}На ковчеге - Платформа для поддержки российской культуры{% endblock %}


{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/profile/settingsProfile/style.css' %}" />
<link rel="stylesheet" href="{% static 'css/profile/stylePersonalAccountSideBar.css' %}" />
{% endblock %}


{% block header %}
{% include "include/profileHeader.html" %}
{% endblock %}


{% block content %}
<section class="edit__block">
    <div class="edit__fon"></div>
    <img class="edit__header--image" src="{% static 'images/profile/settingsProfile/fon2.png' %}">
    <div class="edit__container">
        <div class="edit__sidebar">
            <div class="edit__sidebar--item">
                <div class="edit__sidebar--item-image"><img
                        src="{% static 'images/profile/settingsProfile/icon1-1.png' %}" /></div>
                <p>Профиль</p>
            </div>
            <div class="edit__sidebar--item">
                <div class="edit__sidebar--item-image"><img
                        src="{% static 'images/profile/settingsProfile/icon2-2.png' %}" /></div>
                <p>Верификация</p>
            </div>
            <div class="edit__sidebar--item">
                <div class="edit__sidebar--item-image"><img
                        src="{% static 'images/profile/settingsProfile/icon3-3.png' %}" /></div>
                <p>Мои соцсети</p>
            </div>
            <div class="edit__sidebar--item">
                <div class="edit__sidebar--item-image"><img
                        src="{% static 'images/profile/settingsProfile/icon4-4.png' %}" /></div>
                <p>Активные сессии</p>
            </div>
            <div class="edit__sidebar--item">
                <div class="edit__sidebar--item-image"><img
                        src="{% static 'images/profile/settingsProfile/icon5-5.png' %}" /></div>
                <p>Черный список</p>
            </div>
        </div>
        <div class="edit__content">

            <form method="POST" action="{% url 'change_profile' %}" class="edit__content--item" id="first">
                {% csrf_token %}
                <div class="edit__content--profile">
                    <h2>Профиль</h2>

                    <div class="edit__content--input">
                        <p>Имя или никнейм</p>
                        <input name="username" placeholder="Введите имя"
                            value="{% if user.username %}{{ user.username }}{% endif %}">
                    </div>

                    <div class="edit__content--input">
                        <p>Номер телефона</p>
                        <input name="phone" placeholder="Добавить номер телефона"
                            value="{% if user.phone %}{{ user.phone }}{% endif %}">
                    </div>

                    <div class="edit__content--input">
                        <p>Почта</p>
                        <input name="email" placeholder="Введите почту" value="{{ user.email }}">
                        <button type="submit">Изменить</button>
                    </div>
                </div>

                <div class="edit__content--footer">
                    <a href="#" onclick="return confirm('Вы уверены, что хотите удалить аккаунт?')">Удалить
                        аккаунт</a>
                    <button type="submit">Сохранить</button>
                </div>
            </form>

            {% if not user.privacy_policy_agreed %}
            <div class="edit__content--item" id="second">
                <div class="edit__content--profile">
                    <h2>Верификация</h2>
                    <p class="edit__verification--text">Принимать платежи на платформе «На Корчеге» могут авторы с
                        подтверждённым аккаунтом. Это
                        гарантия безопасности для всех.Уровень проверки зависит от вашего годового дохода.</p>
                    <div class="edit__verification--checkout">
                        <input id="agree" type="checkbox">
                        <p>Я соглашаюсь на обработку моих персональных данных на условиях, описанных
                            в <span>Политике конфиденциальности На Ковчеге</span></p>
                    </div>
                    <div class="edit__verification--button">
                        <button id="continueBtn" disabled>Продолжить</button>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="edit__content--item" id="second">
                <div class="edit__content--profile">
                    <h2>Верификация</h2>
                    <p class="edit__verification--text">Вы уже прошли верефикацию и согласились с политикой
                        конфеденциальности</p>
                </div>
            </div>
            {% endif %}
            <div class="edit__content--item" id="second">
                <div class="edit__content--profile">
                    <h2>Мои соцсети</h2>
                    <div id="socialMessage"
                        style="display: none; margin-bottom: 15px; padding: 10px; border-radius: 5px;"></div>

                    <div class="edit__social--container">
                        <!-- Twitter -->
                        <div class="edit__social--input">
                            <div>
                                <img src="{% static 'images/profile/settingsProfile/social/twitter.png' %}">
                            </div>
                            <input name="twitter" placeholder="Ссылка на аккаунт"
                                value="{{ user.social_links.twitter|default_if_none:'' }}">
                        </div>

                        <!-- TikTok -->
                        <div class="edit__social--input">
                            <div>
                                <img src="{% static 'images/profile/settingsProfile/social/tiktok.png' %}">
                            </div>
                            <input name="tiktok" placeholder="Ссылка на аккаунт"
                                value="{{ user.social_links.tiktok|default_if_none:'' }}">
                        </div>

                        <!-- YouTube -->
                        <div class="edit__social--input">
                            <div>
                                <img src="{% static 'images/profile/settingsProfile/social/youtube.png' %}">
                            </div>
                            <input name="youtube" placeholder="Ссылка на аккаунт"
                                value="{{ user.social_links.youtube|default_if_none:'' }}">
                        </div>

                        <!-- VK -->
                        <div class="edit__social--input">
                            <div>
                                <img src="{% static 'images/profile/settingsProfile/social/vk.png' %}">
                            </div>
                            <input name="vk" placeholder="Ссылка на аккаунт"
                                value="{{ user.social_links.vk|default_if_none:'' }}">
                        </div>

                        <!-- X -->
                        <div class="edit__social--input">
                            <div>
                                <img src="{% static 'images/profile/settingsProfile/social/x.png' %}">
                            </div>
                            <input name="x" placeholder="Ссылка на аккаунт"
                                value="{{ user.social_links.x|default_if_none:'' }}">
                        </div>

                        <!-- B -->
                        <div class="edit__social--input">
                            <div>
                                <img src="{% static 'images/profile/settingsProfile/social/b.png' %}">
                            </div>
                            <input name="b" placeholder="Ссылка на аккаунт"
                                value="{{ user.social_links.b|default_if_none:'' }}">
                        </div>

                        <!-- Instagram -->
                        <div class="edit__social--input">
                            <div>
                                <img src="{% static 'images/profile/settingsProfile/social/inst.png' %}">
                            </div>
                            <input name="instagram" placeholder="Ссылка на аккаунт"
                                value="{{ user.social_links.instagram|default_if_none:'' }}">
                        </div>

                        <!-- Behance -->
                        <div class="edit__social--input">
                            <div>
                                <img src="{% static 'images/profile/settingsProfile/social/be.png' %}">
                            </div>
                            <input name="behance" placeholder="Ссылка на аккаунт"
                                value="{{ user.social_links.behance|default_if_none:'' }}">
                        </div>

                        <!-- Website -->
                        <div class="edit__social--input">
                            <div>
                                <img src="{% static 'images/profile/settingsProfile/social/web.png' %}">
                            </div>
                            <input name="website" placeholder="Ссылка на аккаунт"
                                value="{{ user.social_links.website|default_if_none:'' }}">
                        </div>
                    </div>
                </div>
                <div class="edit__social--footer">
                    <button id="saveSocialLinks">Сохранить</button>
                </div>
            </div>
            <div class="edit__content--item" id="second">
                <div class="edit__content--profile">
                    <h2>Активные сессии</h2>
                    <p class="edit__sessions-text">Текущие устройства</p>
                    <div class="edit__sessions--container">
                        <div class="edit__sessions--item">
                            <div class="edit__sessions--block">
                                <img src="{% static 'images/profile/settingsProfile/icon4-4.png' %}">
                                <div class="edit__sessions--info">
                                    <p>Google Browser 25.08.0, Windows 11</p>
                                    <p>Россия, 123.456.7.890</p>
                                </div>
                            </div>
                            <div class="edit__sessions--date">
                                <p>10.12.2025</p>
                            </div>
                        </div>
                        <div class="edit__sessions--item">
                            <div class="edit__sessions--block">
                                <input type="checkbox">
                                <img src="{% static 'images/profile/settingsProfile/social/apple.png' %}">
                                <div class="edit__sessions--info">
                                    <p>IPhone Валерия</p>
                                    <p>Россия, 123.456.7.890</p>
                                </div>
                            </div>
                            <div class="edit__sessions--date">
                                <p>9.12.2025</p>
                            </div>
                        </div>
                        <p class="edit__sessions--footer-text">Вы можете завершить все сессии разом, кроме текущей.
                        </p>
                    </div>
                </div>
                <div class="edit__social--footer">
                    <button>Завершить сессии</button>
                </div>
            </div>
            <div class="edit__content--item" id="second">
                <div class="edit__content--profile">
                    <h2>Чёрный список</h2>
                    <div class="edit__black--block">
                        <div class="edit__black--item">
                            <div>
                                <img src="{% static 'images/profile/settingsProfile/social/black1.png' %}">
                                <p>Юлия Молчанова</p>
                            </div>
                            <button>Удалить</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block footer %}
{% include "include/profileFooter.html" %}
{% endblock %}

{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/header/header.js' %}"></script>
<script src="{% static 'js/profile/settingsProfile/edit.js' %}"></script>
<script src="{% static 'js/profile/settingsProfile/scriptModalsPayment.js' %}"></script>
<script src="{% static 'js/profile/scriptPersonalAccountSideBar.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const agreeCheckbox = document.getElementById('agree');
        const continueBtn = document.getElementById('continueBtn');
        const verificationSection = document.getElementById('second');

        // Обработчик изменения чекбокса
        agreeCheckbox.addEventListener('change', function () {
            continueBtn.disabled = !this.checked;
        });

        // Обработчик нажатия кнопки
        continueBtn.addEventListener('click', function () {
            if (agreeCheckbox.checked) {
                // Отправляем AJAX запрос на отдельный URL
                fetch("{% url 'agree_privacy_policy' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            agree: true
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Удаляем всю секцию верификации из DOM
                            if (verificationSection) {
                                verificationSection.remove();
                            }
                            alert(data.message);
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Произошла ошибка при отправке данных');
                    });
            }
        });
    });


    document.addEventListener('DOMContentLoaded', function() {
    const saveButton = document.getElementById('saveSocialLinks');
    const messageDiv = document.getElementById('socialMessage');
    
    // Функция для показа сообщений
    function showMessage(message, isSuccess) {
        messageDiv.textContent = message;
        messageDiv.style.display = 'block';
        messageDiv.style.backgroundColor = isSuccess ? '#d4edda' : '#f8d7da';
        messageDiv.style.color = isSuccess ? '#155724' : '#721c24';
        messageDiv.style.border = isSuccess ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
        
        // Автоматически скрыть сообщение через 5 секунд
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 5000);
    }
    
    // Обработчик нажатия кнопки сохранения
    saveButton.addEventListener('click', function() {
        // Собираем данные из всех полей ввода
        const socialData = {
            twitter: document.querySelector('input[name="twitter"]').value,
            tiktok: document.querySelector('input[name="tiktok"]').value,
            youtube: document.querySelector('input[name="youtube"]').value,
            vk: document.querySelector('input[name="vk"]').value,
            x: document.querySelector('input[name="x"]').value,
            b: document.querySelector('input[name="b"]').value,
            instagram: document.querySelector('input[name="instagram"]').value,
            behance: document.querySelector('input[name="behance"]').value,
            website: document.querySelector('input[name="website"]').value
        };
        
        // Отправляем AJAX запрос
        fetch("{% url 'update_social_links' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(socialData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, true);
            } else {
                showMessage(data.message, false);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Произошла ошибка при отправке данных', false);
        });
    });
});
</script>
{% endblock %}