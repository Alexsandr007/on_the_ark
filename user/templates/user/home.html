<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Главная</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>Главная страница</h1>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">Войти</button>
        <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#registerModal">Регистрация</button>
    </div>

    <!-- Модал регистрации -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Регистрация</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label>Username</label>
                            <input type="text" name="username" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>Email</label>
                            <input type="email" name="email" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>Пароль</label>
                            <input type="password" name="password" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>Повторите пароль</label>
                            <input type="password" name="password_confirm" class="form-control" required>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="is_author" class="form-check-input">
                            <label class="form-check-label">Стать автором</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="newsletter" class="form-check-input">
                            <label class="form-check-label">Получать рассылку</label>
                        </div>
                        <button type="submit" class="btn btn-primary">Зарегистрироваться</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Модал входа -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Вход</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label>Email</label>
                            <input type="email" name="username" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>Пароль</label>
                            <input type="password" name="password" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Войти</button>
                        <button type="button" class="btn btn-link" id="forgotPasswordBtn">Забыл пароль</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Модал восстановления пароля -->
<!-- Модал восстановления пароля -->
<div class="modal fade" id="resetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Восстановление пароля</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="resetMessage" style="margin-bottom: 10px;"></div>  <!-- Место для сообщений -->
                <form id="resetForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label>Email</label>
                        <input type="email" name="email" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Восстановить</button>
                </form>
            </div>
        </div>
    </div>
</div>

    <script>
        // Регистрация
        $('#registerForm').on('submit', function(e) {
            e.preventDefault();
            $.post('/register-ajax/', $(this).serialize(), function(data) {
                if (data.success) {
                    window.location.href = data.redirect;
                } else {
                    alert('Ошибки: ' + JSON.stringify(data.errors));
                }
            });
        });

        // Вход
        $('#loginForm').on('submit', function(e) {
            e.preventDefault();
            $.post('/login-ajax/', $(this).serialize(), function(data) {
                if (data.success) {
                    window.location.href = data.redirect;
                } else {
                    alert('Ошибки: ' + JSON.stringify(data.errors));
                }
            });
        });

        // Забыл пароль: закрыть модал входа и открыть восстановление
        $('#forgotPasswordBtn').on('click', function() {
            $('#loginModal').modal('hide');
            $('#resetModal').modal('show');
        });

        // Восстановление
$('#resetForm').on('submit', function(e) {
    e.preventDefault();
    if ($(this).data('submitting')) return;
    $(this).data('submitting', true);
    
    var formData = $(this).serialize();
    console.log('Отправка:', formData);
    $('#resetMessage').text('');
    
    $.ajax({
        url: '/password-reset-ajax/',
        type: 'POST',
        data: formData,
        headers: {
            "X-CSRFToken": getCookie("csrftoken")  // Добавляем CSRF-токен
        },
        success: function(data) {
            console.log('Ответ:', data);
            if (data.success) {
                $('#resetMessage').text(data.message).css('color', 'green');
                setTimeout(() => {
                    $('#resetModal').modal('hide');
                    $('#resetForm')[0].reset();
                }, 2000);
            } else {
                var errorMsg = data.errors ? Object.values(data.errors).join(', ') : 'Ошибка';
                $('#resetMessage').text('Ошибка: ' + errorMsg).css('color', 'red');
            }
        },
        error: function(xhr, status, error) {
            console.error('AJAX error:', status, error, xhr.responseText);
            $('#resetMessage').text('Ошибка сети').css('color', 'red');
        },
        complete: function() {
            $('#resetForm').data('submitting', false);
        }
    });
});

// Функция для получения CSRF-токена
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
        
    </script>
</body>
</html>