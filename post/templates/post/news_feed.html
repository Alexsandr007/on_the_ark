{% extends "user/base.html" %}
{% load static %}

{% block title %}На ковчеге - Лента новостей{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/profile/stylePersonalAccountSideBar.css' %}" />
<link rel="stylesheet" href="{% static 'css/post/feed/style.css' %}" />
<link rel="stylesheet" href="{% static 'css/post/feed/style-reset.css' %}" />
<link rel="stylesheet" href="{% static 'css/post/feed/global-colors.css' %}" />
<link rel="stylesheet" href="{% static 'css/post/feed/global-fonts.css' %}" />
<link rel="stylesheet" href="{% static 'css/post/feed/global-typography.css' %}" />
<link rel="stylesheet" href="{% static 'css/post/feed/buttons.css' %}" />
<link rel="stylesheet" href="{% static 'css/post/feed/page.css' %}" />
<link rel="stylesheet" href="{% static 'css/post/feed/style-333.css' %}" />
<link rel="stylesheet" href="{% static 'css/post/like.css' %}" />
<link rel="stylesheet" href="{% static 'css/post/comments.css' %}" />
<link rel="stylesheet" href="{% static 'css/post/modals/styleModalsPayment.css' %}" />
{% comment %} <link rel="stylesheet" href="{% static 'css/post/modals/styleModals.css' %}" /> {% endcomment %}
{% endblock %}

{% block header %}
{% include "include/profileHeader.html" %}
{% endblock %}

{% block content %}
{% include "post/modals/subscriber_modal.html" %}
<div class="page-overlay"></div>
<main class="profile__articles">
    <div class="container">
        <div class="articles__topbar">
            <h1 class="articles__title">Новости авторов</h1>
            <div class="articles__filter filter _hidden" id="filter">
                <button type="button" class="filter__button" id="filter__button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" fill="#000"
                        id="filter__button-icon">
                        <path
                            d="M6.55556 8.32353C6.55556 7.30017 7.41367 6.47059 8.47222 6.47059C9.53077 6.47059 10.3889 7.30017 10.3889 8.32353C10.3889 9.34688 9.53077 10.1765 8.47222 10.1765C7.41367 10.1765 6.55556 9.34688 6.55556 8.32353ZM8.47222 4C6.00228 4 4 5.93571 4 8.32353C4 10.7114 6.00228 12.6471 8.47222 12.6471C10.9422 12.6471 12.9444 10.7114 12.9444 8.32353C12.9444 5.93571 10.9422 4 8.47222 4ZM15.5 9.55882H25.7222V7.08824H15.5V9.55882ZM20.6111 20.6765C20.6111 19.6532 21.4693 18.8235 22.5278 18.8235C23.5863 18.8235 24.4444 19.6532 24.4444 20.6765C24.4444 21.6998 23.5863 22.5294 22.5278 22.5294C21.4693 22.5294 20.6111 21.6998 20.6111 20.6765ZM22.5278 16.3529C20.0578 16.3529 18.0556 18.2886 18.0556 20.6765C18.0556 23.0643 20.0578 25 22.5278 25C24.9977 25 27 23.0643 27 20.6765C27 18.2886 24.9977 16.3529 22.5278 16.3529ZM5.27778 19.4412V21.9118H15.5V19.4412H5.27778Z"
                            fill="black" />
                    </svg>
                </button>
                <ul class="filter__select _hidden" id="filter__select">
                    <li class="filter__option"><input class="filter__option-checkbox" type="checkbox" name="new-authors"
                            id="new-authors"><label class="filter__option-label" for="new-authors">Новые авторы</label>
                    </li>
                    <li class="filter__option"><input class="filter__option-checkbox" type="checkbox" name="new-posts"
                            id="new-posts"><label class="filter__option-label" for="new-posts">Свежие посты</label></li>
                    <li class="filter__option"><input class="filter__option-checkbox" type="checkbox"
                            name="my-subscriptions" id="my-subscriptions"><label class="filter__option-label"
                            for="my-subscriptions">Мои подписки</label></li>
                    <li class="filter__option"><input class="filter__option-checkbox" type="checkbox" name="paid"
                            id="paid"><label class="filter__option-label" for="paid">Только купленные</label></li>
                    <li class="filter__option"><input class="filter__option-checkbox" type="checkbox" name="free"
                            id="free"><label class="filter__option-label" for="free">Бесплатный контент</label></li>
                </ul>
            </div>
        </div>

        <div class="profile__articles--container">
            {% for post in posts %}
            <div class="profile__articles--item" data-post-id="{{ post.id }}"
         data-published-date="{{ post.published_at|date:'c' }}"
         data-author-id="{{ post.author.id }}"
         data-is-accessible="{{ post.is_accessible|yesno:'true,false' }}"
         data-has-subscription="{{ post.subscription|yesno:'true,false' }}"
         data-author-joined="{{ post.author_joined_date|date:'c' }}">
                <div class="profile__article-card">
                    <div class="profile__article-card--body">
                        <div class="profile__article-card--body-header">
                            <div class="article__details">
                                <div class="author-img">
                                    {% if post.author_photo_url %}
                                    <img src="{{ post.author_photo_url }}" alt="{{ post.author.username }}">
                                    {% else %}
                                    <img src="{% static 'images/profile/profile_default.png' %}"
                                        alt="{{ post.author.username }}">
                                    {% endif %}
                                </div>
                                <div class="details-info">
                                    <p class="author-name">{{ post.author.username }}</p>
                                    <span class="date-of-publication">{{ post.published_at|date:"d M Y H:i" }}</span>
                                </div>
                            </div>
                            <img class="article__share-icon"
                                src="{% static 'images/post/feed/src/images/icon-share.png' %}" alt="Поделиться">
                        </div>

                        {% if not post.is_accessible %}
                        {# Заблокированный контент для платных подписок #}
                        <div class="article__media article__media--paid-content">
                            <p class="paid-content__title">
                                {% if post.title %}
                                {{ post.title }}
                                {% else %}
                                Эксклюзивный контент
                                {% endif %}
                            </p>
                            <img src="{% static 'images/post/feed/src/images/paid-content-icon-lock.svg' %}"
                                alt="Заблокировано">
                            <div class="paid-content__important">
                                <p>Доступно только тарифу «{{ post.subscription.name }}»</p>
                                <div class="paid-content__actions">
<a href="#" class="button button--icon open-subscription-modal" 
   data-subscription-id="{{ post.subscription.id }}">
    <img src="{% static 'images/post/feed/src/images/sub-btn-icon.svg' %}" alt="">
    <span>Подписаться</span>
</a>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        {# Доступный контент #}
                        {% if post.media_list %}
                        {% for media in post.media_list %}
                        {% if media.media_type == 'photo' %}
                        <div class="article__media article__media--image">
                            <img src="{{ media.file.url }}" alt="Изображение поста">
                        </div>
                        {% elif media.media_type == 'video' %}
                        <video class="profile__article--main" controls>
                            <source src="{{ media.file.url }}" type="video/mp4">
                        </video>
                        {% elif media.media_type == 'audio' %}
                        <div class="article__media article__media--audio">
                            <audio controls style="width: 100%;">
                                <source src="{{ media.file.url }}" type="audio/mpeg">
                                Ваш браузер не поддерживает аудио элементы.
                            </audio>
                        </div>
                        {% endif %}
                        {% endfor %}
                        {% endif %}

                        {% if post.content %}
                        <p class="article__description">{{ post.content }}</p>
                        {% endif %}

                        {% if post.tags %}
                        <div class="article__tags">
                            {% for tag in post.tags %}
                            <span class="tag">#{{ tag.name }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% endif %}

                        <div class="profile__article--buttons">
                            <div class="profile__article--btn">
                                <div class="profile__article--btn comment-btn" data-post-id="{{ post.id }}">
                                    <img src="{% static 'images/post/feed/src/images/comments.png' %}"
                                        alt="Комментарии">
                                    <span class="comments-count">{{ post.comments_count }}</span>
                                </div>
                                <div class="profile__article--btn like-btn {% if post.is_liked %}active{% endif %}"
                                    data-post-id="{{ post.id }}">
                                    <img src="{% static 'images/post/feed/src/images/like.png' %}" alt="Лайки"
                                        class="like-icon">
                                    <span class="likes-count">{{ post.likes_count }}</span>
                                </div>
                            </div>

{% if not post.is_accessible %}
<button class="button button--warning open-subscription-modal"
        data-subscription-id="{{ post.subscription.id }}">
    Подписаться
</button>

                            {% elif post.is_ad %}
                            <button class="button button--info">Реклама</button>
                            {% endif %}
                        </div>

                        {# Секция комментариев (можно добавить позже) #}
                        {# Секция комментариев #}
                        {# Секция комментариев #}
                        <div class="comments-section" id="comments-section-{{ post.id }}" style="display: none;">
                            <div class="comments-list">
                                {% for comment in post.comments %}
                                <div class="comment-item">
                                    <div class="comment-author">
                                        {% if comment.author.photo %}
                                        <img src="{{ comment.author.photo.url }}" alt="{{ comment.author.username }}"
                                            class="comment-author-avatar">
                                        {% else %}
                                        <img src="{% static 'images/profile/profile_default.png' %}"
                                            alt="{{ comment.author.username }}" class="comment-author-avatar">
                                        {% endif %}
                                        <strong>{{ comment.author.username }}</strong>
                                    </div>
                                    <div class="comment-content">
                                        {{ comment.content }}
                                    </div>
                                    <div class="comment-date">
                                        {{ comment.created_at|date:"d M Y H:i" }}
                                    </div>
                                </div>
                                {% empty %}
                                <div class="no-comments">Пока нет комментариев</div>
                                {% endfor %}
                            </div>

                            {% if not post.comments_disabled and post.is_accessible %}
                            <form class="comment-form" data-post-id="{{ post.id }}">
                                {% csrf_token %}
                                <div class="comment-input-wrapper">
                                    <textarea class="comment-input" placeholder="Напишите комментарий..." rows="2"
                                        required></textarea>
                                    <button type="submit" class="comment-submit-btn">
                                        <img src="{% static 'images/post/send.svg' %}" alt="Отправить">
                                    </button>
                                </div>
                            </form>
                            {% elif post.comments_disabled %}
                            <div class="comments-disabled">
                                Комментарии отключены для этого поста
                            </div>
                            {% elif not post.is_accessible %}
                            <div class="comments-disabled">
                                Для комментирования необходим доступ к посту
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="no-posts">
                <h2>В ленте пока нет постов</h2>
                <p>Будьте первым, кто опубликует что-то интересное!</p>
            </div>
            {% endfor %}
        </div>
    </div>
</main>
{% endblock %}

{% block footer %}
{% include "include/baseFooter.html" %}
{% endblock %}

{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/header/header.js' %}"></script>
<script src="{% static 'js/post/feed/scriptFilter.js' %}"></script>
<script src="{% static 'js/post/modals/modalPaymentDesktop.js' %}"></script>
<script src="{% static 'js/profile/scriptPersonalAccountSideBar.js' %}"></script>
<script src="{% static 'js/post/like.js' %}"></script>
<script src="{% static 'js/post/comments.js' %}"></script>
<script src="{% static 'js/post/filter_posts.js' %}"></script>

{% endblock %}