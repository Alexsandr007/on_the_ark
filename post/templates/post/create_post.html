<!-- create_post.html -->
{% extends "user/base.html" %}
{% load static %}

{% block title %}На ковчеге - Платформа для поддержки российской культуры{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/post/style.css' %}" />
<link rel="stylesheet" href="{% static 'css/profile/stylePersonalAccountSideBar.css' %}" />
{% endblock %}

{% block header %}
{% include "include/profileHeader.html" %}
{% endblock %}

{% block content %}
<!-- Добавляем проверку на режим редактирования -->
{% if is_edit %}
<input type="hidden" name="post_id" value="{{ post.id }}">
{% endif %}

<form method="post" enctype="multipart/form-data" id="post-form">
  {% csrf_token %}
  <section class="edit__block">
    <div class="edit__fon"></div>
    <img class="edit__header--image" src="{% static 'images/post/fon2.png' %}">
    <div class="ribbons-container">
      <!-- ... ваш существующий SVG код ... -->
    </div>
    <div class="article__container">
      <a href="{% url 'profile' %}" class="back-link">
        <svg width="8" height="13" viewBox="0 0 8 13" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M2.90905 6.50004L8 11.5556L6.54547 13L0 6.50004L6.54547 0L8 1.44445L2.90905 6.50004Z" fill="black" />
        </svg>
        Назад
      </a>

      <!-- Изменяем заголовок в зависимости от режима -->
      <h2 class="main-title">{% if is_edit %}Редактировать пост{% else %}Новый пост{% endif %}</h2>

      <div class="article__body">
        <div class="article__body--main">
          <div class="article__header">
            <div class="article__header--item" id="photo-upload">
              <img src="{% static 'images/post/foto.png' %}">
              Фото
            </div>
            <div class="article__header--item" id="video-upload">
              <img src="{% static 'images/post/video.png' %}">
              Видео
            </div>
            <div class="article__header--item" id="audio-upload">
              <img src="{% static 'images/post/music.png' %}">
              Аудио
            </div>
            {% comment %} <div class="article__header--item" id="poll-create">
              <img src="{% static 'images/post/golos.png' %}">
              Голосование
            </div> {% endcomment %}
            <div class="article__header--item article__header--item-setting">
              <img src="{% static 'images/post/settings.png' %}">
            </div>
          </div>
          <div class="media-preview" id="media-preview" style="{% if is_edit or temp_media_url and temp_media_type %}display:flex;{% else %}display:none;{% endif %}">
            {% if is_edit and post.media.exists %}
            <!-- Превью существующего медиа при редактировании -->
            {% with media=post.media.first %}
            {% if media.media_type == 'photo' %}
            <div class="preview-item preview-image">
              <img src="{{ media.file.url }}" alt="Превью изображения">
              <button type="button" class="preview-remove" data-media-id="{{ media.id }}">×</button>
            </div>
            {% elif media.media_type == 'video' %}
            <div class="preview-item preview-video">
              <video controls>
                <source src="{{ media.file.url }}" type="video/mp4">
                Ваш браузер не поддерживает видео.
              </video>
              <button type="button" class="preview-remove" data-media-id="{{ media.id }}">×</button>
            </div>
            {% elif media.media_type == 'audio' %}
            <div class="preview-item preview-audio">
              <audio controls>
                <source src="{{ media.file.url }}" type="audio/mpeg">
                Ваш браузер не поддерживает аудио.
              </audio>
              <button type="button" class="preview-remove" data-media-id="{{ media.id }}">×</button>
            </div>
            {% endif %}
            {% endwith %}
            {% endif %}

            {% if is_edit and post.poll %}
            <!-- Превью существующего голосования при редактировании -->
            <div class="preview-item preview-poll" >
              <h4>{{ post.poll.question }}</h4>
              <ul>
                {% for option in post.poll.options.all %}
                <li>{{ option.option_text }}</li>
                {% endfor %}
              </ul>
              <button type="button" class="preview-remove" data-poll-id="{{ post.poll.id }}">×</button>
            </div>
            {% endif %}

            <!-- Превью временного медиа (если есть ошибка и файл сохранен) -->
            {% if temp_media_url and temp_media_type %}
            {% if temp_media_type == 'photo' %}
            <div class="preview-item preview-image">
              <img src="{{ temp_media_url }}" alt="Превью изображения">
              <button type="button" class="preview-remove preview-remove-temp">×</button>
            </div>
            {% elif temp_media_type == 'video' %}
            <div class="preview-item preview-video">
              <video controls>
                <source src="{{ temp_media_url }}" type="video/mp4">
                Ваш браузер не поддерживает видео.
              </video>
              <button type="button" class="preview-remove preview-remove-temp">×</button>
            </div>
            {% elif temp_media_type == 'audio' %}
            <div class="preview-item preview-audio">
              <audio controls>
                <source src="{{ temp_media_url }}" type="audio/mpeg">
                Ваш браузер не поддерживает аудио.
              </audio>
              <button type="button" class="preview-remove preview-remove-temp">×</button>
            </div>
            {% endif %}
            {% endif %}
          </div>
          {% if messages %}
          <div class="messages-container">
            {% for message in messages %}
            <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}error{% endif %}">
              {{ message }}
            </div>
            {% endfor %}
          </div>
          {% endif %}
          <div class="article__form">
            <!-- Заполняем поля текущими значениями при редактировании -->
            <input class="article__form--title" placeholder="Заголовок" name="title"
              value="{% if form_data.title %}{{ form_data.title }}{% elif is_edit %}{{ post.title|default:'' }}{% endif %}">

            <textarea placeholder="Текст поста"
              name="content">{% if form_data.content %}{{ form_data.content }}{% elif is_edit %}{{ post.content }}{% endif %}</textarea>

            <!-- В вашей форме замените поле тегов на: -->
            <input class="article__form--tag" placeholder="Теги, не более 6" id="tag_input_display">
            <input type="hidden" name="tags_input" id="hidden_tags_input"
              value="{% if form_data.tags_input %}{{ form_data.tags_input }}{% elif is_edit %}{{ existing_tags }}{% endif %}">
            <div class="article__form--tags">
              <!-- Здесь будут отображаться визуальные теги -->
            </div>

          </div>
        </div>
        <div class="article__body--card">
          <div class="article__body--card-header">
            <p>Кто может видеть пост</p>
          </div>
          <div class="article__body--card-body">
            <label class="article__body--card-item">
              <input type="radio" name="visibility" value="all_users"
                {% if is_edit and post.visibility == 'all_users' %}checked{% endif %}
                {% if not is_edit %}checked{% endif %}>
              Все пользователи
            </label>
            <label class="article__body--card-item">
              <input type="radio" name="visibility" value="subscribers_only"
                {% if is_edit and post.visibility == 'subscribers_only' %}checked{% endif %}>
              Только подписчики
            </label>
            <label class="article__body--card-item">
              <input type="radio" name="visibility" value="one_time_payment"
                {% if is_edit and post.visibility == 'one_time_payment' %}checked{% endif %}>
              Разовая оплата
            </label>
          </div>
        </div>
      </div>
      <div class="article__footer">
        <div class="article__footer--container">
          <div class="article__footer--item">
            <label class="switch__text" for="adpost">Рекламный пост</label>
            <label class="switch">
              <input class="switch__input" type="checkbox" id="adpost" name="is_ad"
                {% if is_edit and post.is_ad %}checked{% endif %}>
              <span class="switch__track" aria-hidden="true"></span>
            </label>
            <!-- Поле для описания рекламы -->
            <textarea name="ad_description" placeholder="О рекламодателе"
              style="display: none;">{% if is_edit %}{{ post.ad_description|default:'' }}{% endif %}</textarea>
          </div>
          {% if not is_edit %}
          <div class="article__footer--item">
            <label class="switch__text" for="schedulepost">Запланировать постинг</label>
            <label class="switch">
              <input class="switch__input" type="checkbox" id="schedulepost"
                {% if is_edit and post.scheduled_at %}checked{% endif %}>
              <span class="switch__track" aria-hidden="true"></span>
            </label>
            <input type="hidden" id="selectedDate" name="scheduled_at"
              value="{% if is_edit and post.scheduled_at %}{{ post.scheduled_at|date:'c' }}{% endif %}">
          </div>
          {% endif %}
          <div class="article__footer--item">
            <label class="switch__text" for="disable_comments">Отключить комментарии</label>
            <label class="switch">
              <input class="switch__input" type="checkbox" id="disable_comments" name="comments_disabled"
                {% if is_edit and post.comments_disabled %}checked{% endif %}>
              <span class="switch__track" aria-hidden="true"></span>
            </label>
          </div>
        </div>
        <!-- Меняем текст кнопки в зависимости от режима -->
        <button type="submit" class="article__footer--btn">
          {% if is_edit %}Обновить пост{% else %}Опубликовать пост{% endif %}
        </button>
      </div>
    </div>
  </section>

  <!-- Скрытые поля для медиа и голосования -->
  <input type="hidden" name="media_type" id="media_type"
    value="{% if form_data.media_type %}{{ form_data.media_type }}{% endif %}">
  <input type="file" name="file" id="file_input" style="display: none;">

  <!-- Заполняем поля голосования если есть -->
  <input type="text" name="question" id="poll_question" placeholder="Вопрос голосования" style="display: none;"
    value="{% if is_edit %}{{ poll_question|default:'' }}{% endif %}">

  <textarea name="options" id="poll_options" placeholder="Варианты через запятую"
    style="display: none;">{% if is_edit %}{{ poll_options|default:'' }}{% endif %}</textarea>
</form>
{% endblock %}

{% block footer %}
{% include "include/baseFooter.html" %}
{% endblock %}

{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/header/header.js' %}"></script>
<script src="{% static 'js/post/create_post.js' %}"></script>
<script src="{% static 'js/post/edit.js' %}"></script>
<script src="{% static 'js/post/tag.js' %}"></script>
<script src="{% static 'js/post/media.js' %}"></script>
<script src="{% static 'js/post/settings.js' %}"></script>
<script src="{% static 'js/post/charCounter.js' %}"></script>
<script src="{% static 'js/post/menu.js' %}"></script>
<script src="{% static 'js/post/editPost.js' %}"></script>
<script src="{% static 'js/profile/scriptPersonalAccountSideBar.js' %}"></script>

<!-- JS для поповера и календаря (без дублирования) -->
<script>
  (() => {
    const items = document.querySelectorAll('.article__footer--item');
    if (items.length < 2) return;

    const adItem = items[0];
    const scheduleItem = items[1];
    const adCheckbox = adItem.querySelector('.switch__input');
    const scheduleCheckbox = scheduleItem.querySelector('.switch__input');
    const selectedDateInput = document.getElementById('selectedDate');

    // контейнеры делаем position:relative
    [adItem, scheduleItem].forEach(el => {
      if (getComputedStyle(el).position === 'static') el.style.position = 'relative';
    });

    // ===== util для поповера
    function getOrCreatePopover(container, key) {
      let pop = container.querySelector(`.af-popover[data-key="${key}"]`);
      if (!pop) {
        pop = document.createElement('div');
        pop.className = 'af-popover';
        pop.dataset.key = key;
        container.appendChild(pop);
      }
      return pop;
    }

    function removePopover(container, key) {
      const pop = container.querySelector(`.af-popover[data-key="${key}"]`);
      if (pop) pop.remove();
    }

    // ===== Рекламный пост: простой блок
    function handleAdToggle() {
      if (adCheckbox.checked) {
        const pop = getOrCreatePopover(adItem, 'ad');
        pop.innerHTML = `
        <div class="af-popover__wrapper">
          <textarea name="" id="" placeholder="О рекламодателе" class="af-popover__textearea"></textarea>
          <p class="af-popover__text">До 150 символов ( осталось 150 )</p>
        </div>
        `;
        // ===== Синхронизация с скрытой textarea =====
        const popoverTextarea = pop.querySelector('.af-popover__textearea');
        const hiddenTextarea = document.querySelector('textarea[name="ad_description"]');
        if (hiddenTextarea) {
          popoverTextarea.value = hiddenTextarea.value; // Загружаем существующее значение
          popoverTextarea.addEventListener('input', function () {
            hiddenTextarea.value = this.value; // Обновляем скрытую textarea
            console.log('ad_description updated:', hiddenTextarea.value); // ===== ОТЛАДКА =====
            // Обновляем счетчик символов
            const remaining = 150 - this.value.length;
            pop.querySelector('.af-popover__text').textContent = `До 150 символов ( осталось ${remaining} )`;
          });
        } else {
          console.error('Hidden textarea not found'); // ===== ОТЛАДКА =====
        }
      } else {
        removePopover(adItem, 'ad');
        // Очищаем скрытую textarea при отключении
        const hiddenTextarea = document.querySelector('textarea[name="ad_description"]');
        if (hiddenTextarea) {
          hiddenTextarea.value = '';
          console.log('ad_description cleared'); // ===== ОТЛАДКА =====
        }
      }
    }

    // ===== Datetime picker (ваш оригинальный код остается без изменений)
    function makeDatePicker({
      initial,
      onApply
    }) {
      // ... (ваш код для календаря, вставьте его сюда)
    }

    function handleScheduleToggle() {
      // ... (ваш код для планирования, вставьте его сюда)
    }

    // подписки + init
    adCheckbox.addEventListener('change', handleAdToggle);
    scheduleCheckbox.addEventListener('change', handleScheduleToggle);
    handleAdToggle();
    handleScheduleToggle();

    // закрытие поповеров при клике вне
    document.addEventListener('click', (e) => {
      const pop = scheduleItem.querySelector('.af-popover[data-key="schedule"]');
      if (pop && !scheduleItem.contains(e.target)) {
        removePopover(scheduleItem, 'schedule');
        scheduleCheckbox.checked = true;
      }

      const adPop = adItem.querySelector('.af-popover[data-key="ad"]');
      if (adPop && !adItem.contains(e.target)) removePopover(adItem, 'ad');
    });
  })();
</script>

<!-- Добавлен скрипт для интеграции медиа/голосования -->
<script>
  // Функция для проверки файла на клиенте
  function validateFile(file, expectedType) {
    const allowedTypes = {
      photo: ['image/jpeg', 'image/png', 'image/gif', 'image/bmp', 'image/webp'],
      video: ['video/mp4', 'video/avi', 'video/quicktime', 'video/x-ms-wmv', 'video/x-flv', 'video/webm'],
      audio: ['audio/mpeg', 'audio/wav', 'audio/flac', 'audio/aac', 'audio/ogg']
    };
    if (!allowedTypes[expectedType].includes(file.type)) {
      alert(`Неверный тип файла для ${expectedType}. Разрешены: ${allowedTypes[expectedType].join(', ')}`);
      return false;
    }
    return true;
  }
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Обработчик для кнопки удаления временного медиа
    document.querySelectorAll('.preview-remove-temp').forEach(button => {
      button.addEventListener('click', function () {
        // Скрыть превью и очистить сессию (нужен AJAX-запрос к view для очистки)
        this.parentElement.style.display = 'none';
        // Пример: отправить AJAX на endpoint для очистки сессии
        fetch('/clear_temp_media/', {
          method: 'POST'
        }); // Создайте такой URL в urls.py
      });
    });
  });
</script>
{% endblock %}